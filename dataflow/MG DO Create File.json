{
	"name": "MG DO Create File",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Sandbox_Transaction",
						"type": "DatasetReference"
					},
					"name": "transaction"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "MG_debit_order_temp",
						"type": "DatasetReference"
					},
					"name": "CreateFileTemp"
				},
				{
					"dataset": {
						"referenceName": "MG_debit_order_history",
						"type": "DatasetReference"
					},
					"name": "CreateFileHistory"
				}
			],
			"transformations": [
				{
					"name": "derivedColumns"
				},
				{
					"name": "windowIndex"
				}
			],
			"scriptLines": [
				"parameters{",
				"     submissiondate as string ('SubmissionDate'),",
				"     division as string ('Division'),",
				"     paymentmethod as string ('PaymentMethod')",
				"}",
				"source(output(",
				"          {@odata.etag} as string,",
				"          cog_account as string,",
				"          cog_contact as string,",
				"          transactioncurrencyid as string,",
				"          cog_accountholder as string,",
				"          cog_accountnumber as string,",
				"          cog_donornumber as string,",
				"          cog_expireydate as string,",
				"          cog_transactionamount as string,",
				"          cog_transactiondate as string,",
				"          cog_transactionid as string,",
				"          cog_transactionno as string,",
				"          statecode as string,",
				"          statuscode as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     query: '<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\" no-lock=\"false\">\\n     <entity name=\"cog_transaction\">\\n          <attribute name=\"cog_transactionno\"/>\\n          <attribute name=\"cog_transactionamount\"/>\\n          <attribute name=\"cog_transactionid\"/>\\n          <order attribute=\"cog_transactionno\" descending=\"true\"/>\\n          <attribute name=\"cog_accountholder\"/>\\n          <attribute name=\"cog_accountnumber\"/>\\n          <attribute name=\"cog_expireydate\"/>\\n          <attribute name=\"cog_account\"/>\\n          <attribute name=\"cog_contact\"/>\\n          <attribute name=\"statecode\"/>\\n          <attribute name=\"statuscode\"/>\\n          <attribute name=\"cog_transactiondate\"/>\\n          <attribute name=\"cog_donornumber\"/>\\n          <attribute name=\"cog_branchcode\"/>\\n          <filter type=\"and\">\\n               <condition attribute=\"statecode\" operator=\"eq\" value=\"0\"/>\\n               <condition attribute=\"statuscode\" operator=\"eq\" value=\"1\"/>\\n               <condition attribute=\"cog_division\" operator=\"eq\" value=\"181310001\"/>\\n               <condition attribute=\"cog_paymentmethod\" operator=\"eq\" value=\"181310003\"/>\\n          </filter>\\n     </entity>\\n</fetch>') ~> transaction",
				"transaction derive(Field1 = '0000000000',",
				"          {Customer Number} = 'cog_donornumber',",
				"          {Type of Service} = 'A',",
				"          {Name of Member} = upper(cog_accountholder),",
				"          {Account Name} = replace(upper(cog_accountholder),' ',''),",
				"          {Account Number} = 'cog_accountnumber',",
				"          Filler2 = '          ',",
				"          {Branch Code} = 'branchcode',",
				"          {Type of Account} = '1',",
				"          Description = '                    ',",
				"          {Nominated Account} = '02',",
				"          Filler3 = '00000',",
				"          Amount = 'cog_transactionamount',",
				"          {Amount Arrear} = '00000000000',",
				"          {Max Amount} = '99999999999',",
				"          {Capital Amount} = '00000000000',",
				"          {Special Amount} = '00000000000',",
				"          {Action Date} = toString($submissiondate,'yyyy-mm-dd'),",
				"          {Cancellation Date} = '00000000000',",
				"          Frequency = '01',",
				"          Filler4 = '  ',",
				"          {Record Type Code} = '00',",
				"          {Entry Class Code} = '00') ~> derivedColumns",
				"derivedColumns window(asc({@odata.etag}, true),",
				"     index = rowNumber()) ~> windowIndex",
				"windowIndex sink(allowSchemaDrift: false,",
				"     validateSchema: false,",
				"     input(",
				"          accountholder as string,",
				"          accountnumber as string,",
				"          expireydate as string,",
				"          amount as string,",
				"          reference as string,",
				"          type as string,",
				"          budgetperiod as string",
				"     ),",
				"     filePattern:($division+'-'+$paymentmethod+'-'+$submissiondate+'.csv'),",
				"     truncate: true,",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     mapColumn(",
				"          amount = Amount,",
				"          budgetperiod",
				"     )) ~> CreateFileTemp",
				"windowIndex sink(allowSchemaDrift: false,",
				"     validateSchema: false,",
				"     input(",
				"          accountholder as string,",
				"          accountnumber as string,",
				"          expireydate as string,",
				"          amount as string,",
				"          reference as string,",
				"          type as string,",
				"          budgetperiod as string",
				"     ),",
				"     filePattern:($division+'-'+$paymentmethod+'-'+$submissiondate+'.csv'),",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     mapColumn(",
				"          accountholder = cog_accountholder,",
				"          accountnumber = cog_accountnumber,",
				"          expireydate = cog_expireydate,",
				"          amount = cog_transactionamount,",
				"          reference = cog_transactionid,",
				"          type = {Type of Service},",
				"          budgetperiod",
				"     )) ~> CreateFileHistory"
			]
		}
	}
}