{
	"name": "MG CC Create File",
	"properties": {
		"type": "MappingDataFlow",
		"typeProperties": {
			"sources": [
				{
					"dataset": {
						"referenceName": "Sandbox_Transaction",
						"type": "DatasetReference"
					},
					"name": "transaction"
				}
			],
			"sinks": [
				{
					"dataset": {
						"referenceName": "MG_credit_card_temp",
						"type": "DatasetReference"
					},
					"name": "CreateFileTemp"
				},
				{
					"dataset": {
						"referenceName": "MG_credit_card_history",
						"type": "DatasetReference"
					},
					"name": "CreateFileHistory"
				}
			],
			"transformations": [
				{
					"name": "derivedColumns"
				},
				{
					"name": "windowIndex"
				}
			],
			"scriptLines": [
				"parameters{",
				"     submissiondate as string ('SubmissionDate'),",
				"     division as string ('Division'),",
				"     paymentmethod as string ('PaymentMethod')",
				"}",
				"source(output(",
				"          {@odata.etag} as string,",
				"          cog_account as string,",
				"          cog_contact as string,",
				"          transactioncurrencyid as string,",
				"          cog_accountholder as string,",
				"          cog_accountnumber as string,",
				"          cog_expireydate as string,",
				"          cog_transactionamount as string,",
				"          cog_transactiondate as string,",
				"          cog_transactionid as string,",
				"          cog_transactionno as string,",
				"          statecode as string,",
				"          statuscode as string",
				"     ),",
				"     allowSchemaDrift: true,",
				"     validateSchema: false,",
				"     query: '<fetch version=\"1.0\" output-format=\"xml-platform\" mapping=\"logical\" distinct=\"false\" no-lock=\"false\">\\n     <entity name=\"cog_transaction\">\\n          <attribute name=\"cog_transactionno\"/>\\n          <attribute name=\"cog_transactionamount\"/>\\n          <attribute name=\"cog_transactionid\"/>\\n          <order attribute=\"cog_transactionno\" descending=\"true\"/>\\n          <attribute name=\"cog_accountholder\"/>\\n          <attribute name=\"cog_accountnumber\"/>\\n          <attribute name=\"cog_expireydate\"/>\\n          <attribute name=\"cog_account\"/>\\n          <attribute name=\"cog_contact\"/>\\n          <attribute name=\"statecode\"/>\\n          <attribute name=\"statuscode\"/>\\n          <attribute name=\"cog_transactiondate\"/>\\n          <filter type=\"and\">\\n               <condition attribute=\"statecode\" operator=\"eq\" value=\"0\"/>\\n               <condition attribute=\"statuscode\" operator=\"eq\" value=\"1\"/>\\n               <condition attribute=\"cog_division\" operator=\"eq\" value=\"181310001\"/>\\n               <condition attribute=\"cog_paymentmethod\" operator=\"eq\" value=\"181310001\"/>\\n          </filter>\\n     </entity>\\n</fetch>') ~> transaction",
				"transaction derive({Type (A)} = 'A',",
				"          {Transaction Reference} = cog_transactionno,",
				"          {Card Holder Name} = cog_accountholder,",
				"          {Card Number} = cog_accountnumber,",
				"          {Expiry Date} = concat(substringIndex(substringIndex(cog_expireydate,'-',2),'-',-1),substringIndex(substringIndex(cog_expireydate,'-',2),'-',1)),",
				"          {Budget Period} = '00',",
				"          Amount = concat(replace(cog_transactionamount,'.',''),'0')) ~> derivedColumns",
				"derivedColumns window(asc({@odata.etag}, true),",
				"     index = rowNumber()) ~> windowIndex",
				"windowIndex sink(allowSchemaDrift: false,",
				"     validateSchema: false,",
				"     input(",
				"          Type as string,",
				"          { Transaction Reference} as string,",
				"          {Card Holder Name} as string,",
				"          { Card Number} as string,",
				"          { Expiry Date} as string,",
				"          { Budget Period} as string,",
				"          { Amount} as string",
				"     ),",
				"     filePattern:($division+'-'+$paymentmethod+'-'+$submissiondate+'.csv'),",
				"     truncate: true,",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     mapColumn(",
				"          accountholder = cog_accountholder,",
				"          accountnumber = cog_accountnumber,",
				"          expireydate = cog_expireydate,",
				"          amount = cog_transactionamount,",
				"          reference = cog_transactionid,",
				"          type = {Type (A)},",
				"          budgetperiod = {Budget Period}",
				"     )) ~> CreateFileTemp",
				"windowIndex sink(allowSchemaDrift: false,",
				"     validateSchema: false,",
				"     input(",
				"          Field1 as string,",
				"          {Customer Number} as string,",
				"          {Type of Service} as string,",
				"          {Name of member} as string,",
				"          {Account Name} as string,",
				"          {Account Number} as string,",
				"          Filler2 as string,",
				"          {Branch Code} as string,",
				"          {Type of Account} as string,",
				"          Description as string,",
				"          {Nominated Account} as string,",
				"          Filler3 as string,",
				"          Amount as string,",
				"          {Amount Arrear} as string,",
				"          {Max Amount} as string,",
				"          {Capital Amount} as string,",
				"          {Special Amount} as string,",
				"          {Action Date} as string,",
				"          {Cancellation Date} as string,",
				"          Frequency as string,",
				"          Filler4 as string,",
				"          {Record Type Code} as string,",
				"          {Entry Class Code} as string",
				"     ),",
				"     filePattern:($division+'-'+$paymentmethod+'-'+$submissiondate+'.csv'),",
				"     umask: 0022,",
				"     preCommands: [],",
				"     postCommands: [],",
				"     mapColumn(",
				"          accountholder = cog_accountholder,",
				"          accountnumber = cog_accountnumber,",
				"          expireydate = cog_expireydate,",
				"          amount = cog_transactionamount,",
				"          reference = cog_transactionid,",
				"          type = {Type (A)},",
				"          budgetperiod = {Budget Period}",
				"     )) ~> CreateFileHistory"
			]
		}
	}
}